# FIXO - Continuous Integration
name: CI

on:
  push:
    branches: [main, develop, 'feature/*', 'claude/*']
  pull_request:
    branches: [main, develop]

jobs:
  validate-files:
    name: Validate Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          echo "Checking required files..."
          test -f index.html && echo "‚úÖ index.html exists" || (echo "‚ùå index.html not found" && exit 1)
          test -f manifest.json && echo "‚úÖ manifest.json exists" || (echo "‚ùå manifest.json not found" && exit 1)
          test -f service-worker.js && echo "‚úÖ service-worker.js exists" || (echo "‚ùå service-worker.js not found" && exit 1)
          test -f src/app.js && echo "‚úÖ src/app.js exists" || (echo "‚ùå src/app.js not found" && exit 1)
          test -d styles && echo "‚úÖ styles/ directory exists" || (echo "‚ùå styles/ not found" && exit 1)
          test -d data && echo "‚úÖ data/ directory exists" || (echo "‚ùå data/ not found" && exit 1)
          test -d assets/icons && echo "‚úÖ assets/icons/ directory exists" || (echo "‚ùå assets/icons/ not found" && exit 1)

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          for file in data/*.json manifest.json; do
            if [ -f "$file" ]; then
              python3 -m json.tool "$file" > /dev/null && echo "‚úÖ $file is valid" || (echo "‚ùå $file is invalid" && exit 1)
            fi
          done

      - name: Check HTML syntax
        run: |
          echo "Checking HTML files..."
          # Basic HTML validation - check for DOCTYPE and basic structure
          if grep -q "<!DOCTYPE html>" index.html; then
            echo "‚úÖ index.html has DOCTYPE"
          else
            echo "‚ùå index.html missing DOCTYPE"
            exit 1
          fi

      - name: Check CSS files
        run: |
          echo "Checking CSS files..."
          test -f styles/main.css && echo "‚úÖ styles/main.css exists" || (echo "‚ùå styles/main.css not found" && exit 1)
          test -f styles/design-system.css && echo "‚úÖ styles/design-system.css exists" || (echo "‚ùå styles/design-system.css not found" && exit 1)
          test -f styles/components.css && echo "‚úÖ styles/components.css exists" || (echo "‚ùå styles/components.css not found" && exit 1)
          test -f styles/layout.css && echo "‚úÖ styles/layout.css exists" || (echo "‚ùå styles/layout.css not found" && exit 1)
          test -f styles/app.css && echo "‚úÖ styles/app.css exists" || (echo "‚ùå styles/app.css not found" && exit 1)

      - name: Check JavaScript files
        run: |
          echo "Checking JavaScript files..."
          # Check if files exist and are not empty
          if [ -f src/app.js ] && [ -s src/app.js ]; then
            echo "‚úÖ src/app.js exists and is not empty"
          else
            echo "‚ùå src/app.js is missing or empty"
            exit 1
          fi
          # Service worker is pure JS, can be checked with Node
          node --check service-worker.js && echo "‚úÖ service-worker.js syntax is valid" || (echo "‚ùå service-worker.js has syntax errors" && exit 1)

      - name: Validate PWA icons
        run: |
          echo "Checking PWA icons..."
          for size in 72 96 128 144 152 192 384 512; do
            test -f "assets/icons/icon-${size}x${size}.png" && echo "‚úÖ icon-${size}x${size}.png exists" || (echo "‚ùå icon-${size}x${size}.png not found" && exit 1)
          done

  security-check:
    name: Security Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets in code
        run: |
          echo "Checking for potential secrets..."
          # Check for common secret patterns (excluding examples)
          if grep -rE "(api[_-]?key|secret|password|token)\s*[:=]\s*['\"][^'\"]+['\"]" \
            --include="*.js" \
            --include="*.json" \
            --include="*.html" \
            . 2>/dev/null | \
            grep -v ".env" | \
            grep -v "example" | \
            grep -v "G-XXXXXXXXXX" | \
            grep -v "OPENAI_API_KEY"; then
            echo "‚ö†Ô∏è Potential secrets found! Review the above matches."
            exit 1
          else
            echo "‚úÖ No obvious secrets detected"
          fi

      - name: Check .env is gitignored
        run: |
          if grep -q "^\.env$" .gitignore 2>/dev/null || grep -q "^\.env\$" .gitignore 2>/dev/null; then
            echo "‚úÖ .env is in .gitignore"
          else
            echo "‚ö†Ô∏è .env should be in .gitignore (non-critical)"
          fi

  data-integrity:
    name: Data Integrity Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate repairs database
        run: |
          echo "Validating repairs.json structure..."
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('data/repairs.json', 'utf8'));

            if (!Array.isArray(data)) {
              console.error('‚ùå repairs.json must be an array');
              process.exit(1);
            }

            console.log(\`‚úÖ repairs.json contains \${data.length} items\`);

            // Check basic structure
            const firstItem = data[0];
            if (firstItem && typeof firstItem === 'object') {
              console.log('‚úÖ repairs.json structure looks valid');
            } else {
              console.error('‚ùå repairs.json structure is invalid');
              process.exit(1);
            }
          "

      - name: Validate translations
        run: |
          echo "Validating translations.json..."
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('data/translations.json', 'utf8'));

            if (typeof data !== 'object') {
              console.error('‚ùå translations.json must be an object');
              process.exit(1);
            }

            const languages = Object.keys(data);
            console.log(\`‚úÖ translations.json contains \${languages.length} languages\`);
          "

      - name: Check data file sizes
        run: |
          echo "Checking data file sizes..."
          du -sh data/*.json | while read size file; do
            echo "üìä $file: $size"
          done

  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [validate-files, security-check, data-integrity]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| File Validation | ${{ needs.validate-files.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Check | ${{ needs.security-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Data Integrity | ${{ needs.data-integrity.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.validate-files.result }}" == "success" ] && \
             [ "${{ needs.security-check.result }}" == "success" ] && \
             [ "${{ needs.data-integrity.result }}" == "success" ]; then
            echo "‚úÖ All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Some checks failed. Please review the logs." >> $GITHUB_STEP_SUMMARY
          fi

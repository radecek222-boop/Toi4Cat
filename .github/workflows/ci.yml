# FIXO - Continuous Integration
name: CI

on:
  push:
    branches: [main, develop, 'feature/*', 'claude/*']
  pull_request:
    branches: [main, develop]

jobs:
  validate:
    name: Validate Project
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check Core Files
        run: |
          echo "ðŸ“‹ Checking required files..."
          test -f index.html && echo "âœ… index.html" || exit 1
          test -f manifest.json && echo "âœ… manifest.json" || exit 1
          test -f service-worker.js && echo "âœ… service-worker.js" || exit 1
          test -f src/app.js && echo "âœ… src/app.js" || exit 1
          test -d styles && echo "âœ… styles/" || exit 1
          test -d assets/icons && echo "âœ… assets/icons/" || exit 1

      - name: Validate JSON Files
        run: |
          echo "ðŸ” Validating JSON syntax..."
          for file in data/*.json manifest.json 2>/dev/null; do
            [ -f "$file" ] && python3 -m json.tool "$file" > /dev/null && echo "âœ… $file" || exit 1
          done

      - name: Check HTML Syntax
        run: |
          grep -q "<!DOCTYPE html>" index.html && echo "âœ… HTML DOCTYPE valid" || exit 1

      - name: Validate JavaScript
        run: |
          node --check service-worker.js && echo "âœ… service-worker.js syntax valid" || exit 1
          [ -s src/app.js ] && echo "âœ… src/app.js exists" || exit 1

      - name: Check PWA Icons
        run: |
          echo "ðŸŽ¨ Checking PWA icons..."
          for size in 72 96 128 144 152 192 384 512; do
            test -f "assets/icons/icon-${size}x${size}.png" && echo "âœ… ${size}x${size}" || exit 1
          done

      - name: Security Check
        run: |
          echo "ðŸ”’ Security scan..."
          if grep -rE "(api[_-]?key|secret|password|token)\s*[:=]\s*['\"][^'\"]+['\"]" \
            --include="*.js" --include="*.json" --include="*.html" . 2>/dev/null | \
            grep -v ".env" | grep -v "example" | grep -v "G-XXXXXXXXXX" | grep -v "OPENAI_API_KEY"; then
            echo "âš ï¸ Potential secrets found!"
            exit 1
          fi
          echo "âœ… No secrets detected"

      - name: Summary
        if: always()
        run: |
          echo "## âœ… CI Complete" >> $GITHUB_STEP_SUMMARY
          echo "All validation checks passed!" >> $GITHUB_STEP_SUMMARY
